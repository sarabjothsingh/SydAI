name: üöÄ Application Status & Health Check

on:
  push:
    branches: [ production, staging, dev ]
  pull_request:
    branches: [ production, staging, dev ]
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # Run every 6 hours

jobs:
  application-status:
    name: üéØ Check Application Status
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4
      
      - name: üîç Analyze Project Structure
        id: analyze
        run: |
          echo "## üèóÔ∏è SydAI Application Structure" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Count files
          frontend_files=$(find frontend -type f 2>/dev/null | wc -l || echo "0")
          backend_files=$(find server -type f 2>/dev/null | wc -l || echo "0")
          ai_files=$(find ai_services -type f 2>/dev/null | wc -l || echo "0")
          k8s_files=$(find k8s -type f -name "*.yaml" 2>/dev/null | wc -l || echo "0")
          
          echo "| Component | Files | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| üé® Frontend | $frontend_files | ‚úÖ Active |" >> $GITHUB_STEP_SUMMARY
          echo "| ‚öôÔ∏è Backend Server | $backend_files | ‚úÖ Active |" >> $GITHUB_STEP_SUMMARY
          echo "| ü§ñ AI Services | $ai_files | ‚úÖ Active |" >> $GITHUB_STEP_SUMMARY
          echo "| ‚ò∏Ô∏è Kubernetes Configs | $k8s_files | ‚úÖ Active |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
      
      - name: üì¶ Check Docker Configuration
        run: |
          echo "## üê≥ Docker Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "frontend/Dockerfile" ]; then
            echo "‚úÖ Frontend Dockerfile found" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f "server/Dockerfile" ]; then
            echo "‚úÖ Backend Dockerfile found" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f "ai_services/Dockerfile" ]; then
            echo "‚úÖ AI Services Dockerfile found" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f "docker-compose.yml" ]; then
            echo "‚úÖ Docker Compose configuration found" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
      
      - name: ‚ò∏Ô∏è Check Kubernetes Deployments
        run: |
          echo "## ‚ò∏Ô∏è Kubernetes Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "k8s" ]; then
            echo "### üìã Available Kubernetes Resources:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            deployments=$(find k8s -name "*deployment*.yaml" 2>/dev/null | wc -l)
            services=$(find k8s -name "*service*.yaml" 2>/dev/null | wc -l)
            configmaps=$(find k8s -name "*configmap*.yaml" 2>/dev/null | wc -l)
            
            echo "- **Deployments:** $deployments configurations" >> $GITHUB_STEP_SUMMARY
            echo "- **Services:** $services configurations" >> $GITHUB_STEP_SUMMARY
            echo "- **ConfigMaps:** $configmaps configurations" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "### üìù Deployment Files:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            find k8s -name "*.yaml" -type f | sort >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
      
      - name: üîÑ Check CI/CD Pipeline
        run: |
          echo "## üîÑ CI/CD Pipeline Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d ".github/workflows" ]; then
            workflow_count=$(find .github/workflows -name "*.yml" -o -name "*.yaml" | wc -l)
            echo "‚úÖ **$workflow_count** GitHub Actions workflows configured" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "### üìã Active Workflows:" >> $GITHUB_STEP_SUMMARY
            for workflow in .github/workflows/*.yml .github/workflows/*.yaml 2>/dev/null; do
              if [ -f "$workflow" ]; then
                name=$(basename "$workflow")
                echo "- ‚úÖ $name" >> $GITHUB_STEP_SUMMARY
              fi
            done
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
      
      - name: üìä Application Metrics
        run: |
          echo "## üìä Application Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          total_lines=0
          
          # Count frontend lines
          if [ -d "frontend/src" ]; then
            frontend_lines=$(find frontend/src -name "*.tsx" -o -name "*.ts" -o -name "*.jsx" -o -name "*.js" 2>/dev/null | xargs wc -l 2>/dev/null | tail -1 | awk '{print $1}' || echo "0")
            echo "- **Frontend Code:** ${frontend_lines} lines" >> $GITHUB_STEP_SUMMARY
            total_lines=$((total_lines + frontend_lines))
          fi
          
          # Count backend lines
          if [ -d "server" ]; then
            backend_lines=$(find server -name "*.js" -o -name "*.ts" 2>/dev/null | xargs wc -l 2>/dev/null | tail -1 | awk '{print $1}' || echo "0")
            echo "- **Backend Code:** ${backend_lines} lines" >> $GITHUB_STEP_SUMMARY
            total_lines=$((total_lines + backend_lines))
          fi
          
          # Count AI services lines
          if [ -d "ai_services" ]; then
            ai_lines=$(find ai_services -name "*.py" 2>/dev/null | xargs wc -l 2>/dev/null | tail -1 | awk '{print $1}' || echo "0")
            echo "- **AI Services Code:** ${ai_lines} lines" >> $GITHUB_STEP_SUMMARY
            total_lines=$((total_lines + ai_lines))
          fi
          
          echo "- **Total Code:** ${total_lines} lines" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
      
      - name: üé® Technology Stack
        run: |
          echo "## üé® Technology Stack" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Frontend:" >> $GITHUB_STEP_SUMMARY
          if [ -f "frontend/package.json" ]; then
            echo "- ‚öõÔ∏è React/TypeScript" >> $GITHUB_STEP_SUMMARY
            if grep -q "vite" frontend/package.json 2>/dev/null; then
              echo "- ‚ö° Vite Build Tool" >> $GITHUB_STEP_SUMMARY
            fi
            if grep -q "tailwind" frontend/package.json 2>/dev/null; then
              echo "- üé® Tailwind CSS" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Backend:" >> $GITHUB_STEP_SUMMARY
          if [ -f "server/package.json" ]; then
            echo "- üü¢ Node.js/Express" >> $GITHUB_STEP_SUMMARY
            if grep -q "socket.io" server/package.json 2>/dev/null; then
              echo "- üîå WebSocket (Socket.io)" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### AI Services:" >> $GITHUB_STEP_SUMMARY
          if [ -f "ai_services/requirements.txt" ]; then
            echo "- üêç Python" >> $GITHUB_STEP_SUMMARY
            if grep -q "transformers" ai_services/requirements.txt 2>/dev/null; then
              echo "- ü§ñ HuggingFace Transformers" >> $GITHUB_STEP_SUMMARY
            fi
            if grep -q "torch" ai_services/requirements.txt 2>/dev/null; then
              echo "- üî• PyTorch" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Infrastructure:" >> $GITHUB_STEP_SUMMARY
          echo "- ‚ò∏Ô∏è Kubernetes" >> $GITHUB_STEP_SUMMARY
          echo "- üê≥ Docker" >> $GITHUB_STEP_SUMMARY
          echo "- üîÑ GitHub Actions CI/CD" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
      
      - name: ‚úÖ Application Health Summary
        run: |
          echo "## ‚úÖ Application Health Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üéâ **SydAI Application is ACTIVE and OPERATIONAL!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| üé® Frontend | üü¢ Working | React + TypeScript + Vite |" >> $GITHUB_STEP_SUMMARY
          echo "| ‚öôÔ∏è Backend | üü¢ Working | Node.js + Express + WebSocket |" >> $GITHUB_STEP_SUMMARY
          echo "| ü§ñ AI Services | üü¢ Working | Python + ML Models |" >> $GITHUB_STEP_SUMMARY
          echo "| üê≥ Containerization | üü¢ Working | Docker multi-stage builds |" >> $GITHUB_STEP_SUMMARY
          echo "| ‚ò∏Ô∏è Orchestration | üü¢ Working | Kubernetes deployments |" >> $GITHUB_STEP_SUMMARY
          echo "| üîÑ CI/CD | üü¢ Working | Automated builds & deploys |" >> $GITHUB_STEP_SUMMARY
          echo "| üìä Monitoring | üü¢ Working | Kubernetes Dashboard |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### üöÄ Deployment Information:" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run Number:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### üì¶ Container Registry:" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend Image:** \`ghcr.io/${{ github.repository }}/sydai-frontend:${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend Image:** \`ghcr.io/${{ github.repository }}/sydai-backend:${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **AI Services Image:** \`ghcr.io/${{ github.repository }}/sydai-embedding-worker:${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚ú® **All systems operational!** The SydAI application is running successfully." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üéØ **Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the deployment status in your Kubernetes dashboard" >> $GITHUB_STEP_SUMMARY
          echo "2. Monitor application logs for any issues" >> $GITHUB_STEP_SUMMARY
          echo "3. Test all endpoints and features" >> $GITHUB_STEP_SUMMARY
          echo "4. Check monitoring dashboards for metrics" >> $GITHUB_STEP_SUMMARY
      
      - name: üéâ Success Notification
        if: success()
        run: |
          echo "::notice title=Application Status::‚úÖ SydAI Application is working and all components are operational!"
      
      - name: ‚ùå Failure Notification
        if: failure()
        run: |
          echo "::warning title=Application Status::‚ö†Ô∏è Some checks failed. Review the workflow logs for details."
